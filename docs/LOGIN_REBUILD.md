# ุฅุนุงุฏุฉ ุจูุงุก ูุธุงู ุชุณุฌูู ุงูุฏุฎูู ูุน Supabase MCP

**ุงูุชุงุฑูุฎ:** 2025-01-16  
**ุงูุญุงูุฉ:** โ ููุชูู

---

## ๐ ููุฎุต ุงูุชุบููุฑุงุช

ุชู ุฅุนุงุฏุฉ ุจูุงุก ูุธุงู ุชุณุฌูู ุงูุฏุฎูู ุจุงููุงูู ููุชูุงูู ุจุดูู ุฃูุถู ูุน Supabase MCP ูููููู ุฃุจุณุท ูุฃูุซุฑ ููุซูููุฉ.

---

## โ ุงูุชุญุณููุงุช ุงููุทุจูุฉ

### 1. ุฅุนุงุฏุฉ ุจูุงุก Login Controller โ

#### ูุจู:
- ููุฏ ูุนูุฏ ูุน ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุชุนุฏุฏุฉ ุงูุทุจูุงุช
- ูุญุงููุงุช ูุชุนุฏุฏุฉ ูุฅูุดุงุก user record
- ูุนุงูุฌุฉ ูุนูุฏุฉ ูู admin client
- ููุฏ ููุฑุฑ ููุนูุฏ

#### ุจุนุฏ:
- **ููุฏ ูุจุณุท ูููุธู** - ุฎุทูุงุช ูุงุถุญุฉ ููุชุณูุณูุฉ
- **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุฃูุถู** - ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ููููุฏุฉ
- **ุงุณุชุฎุฏุงู ูุจุงุดุฑ ูู Supabase Auth** - ุจุฏูู ุชุนููุฏุงุช ุบูุฑ ุถุฑูุฑูุฉ
- **ุชุนูููุงุช ูุงุถุญุฉ** - ูู ุฎุทูุฉ ููุซูุฉ

#### ุงูุฎุทูุงุช ุงูุฌุฏูุฏุฉ:
1. **ุงูุชุญูู ูู ุงูุจูุงูุงุช** - ุงูุชุฃูุฏ ูู ูุฌูุฏ email ู password
2. **ุงููุตุงุฏูุฉ ูุน Supabase Auth** - ุงุณุชุฎุฏุงู `signInWithPassword`
3. **ุงูุชุฃูุฏ ูู ูุฌูุฏ user record** - ุงุณุชุฎุฏุงู `ensureUserRecord`
4. **ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู** - ูู ุฌุฏูู users (role, status, mfa)
5. **ุชุญุฏูุฏ ุงูุฏูุฑ** - ูุน fallback chain ูุงุถุญ
6. **ุชุนููู ุงูููููุฒ** - ุญูุธ tokens ูู cookies
7. **ุฅุฑุฌุงุน ุงูุงุณุชุฌุงุจุฉ** - ุจูุงูุงุช ุงููุณุชุฎุฏู ูุงูุฌูุณุฉ

### 2. ุฅุตูุงุญ ูุดุงูู RLS ูู ุฌุฏูู Sessions โ

ุชู ุชูุนูู RLS ุนูู ุฌุฏูู `sessions` ูุฅุถุงูุฉ policies:

- โ **RLS ููุนูู** ุนูู ุฌุฏูู sessions
- โ **Policy ูููุฑุงุกุฉ** - ุงููุณุชุฎุฏููู ูุฑูู ุฌูุณุงุชูู ููุท
- โ **Policy ููุฅุฏุฑุงุฌ** - ุงููุณุชุฎุฏููู ูุถูููู ุฌูุณุงุชูู ููุท
- โ **Policy ููุชุญุฏูุซ** - ุงููุณุชุฎุฏููู ูุญุฏุซูู ุฌูุณุงุชูู ููุท
- โ **Policy ููุญุฐู** - ุงููุณุชุฎุฏููู ูุญุฐููู ุฌูุณุงุชูู ููุท
- โ **Policy ููุฎุฏูุฉ** - Service role ูู ุตูุงุญูุงุช ูุงููุฉ

### 3. ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก โ

- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ููููุฏุฉ
- โ ููุฏ ุฎุทุฃ ููุงุณุจ ููู ุญุงูุฉ
- โ ุชุณุฌูู ููุตู ููุฃุฎุทุงุก ููุชุทููุฑ
- โ ูุนุงูุฌุฉ ุขููุฉ ููุฃุฎุทุงุก ุบูุฑ ุงููุชููุนุฉ

---

## ๐ง ุงูุชุบููุฑุงุช ุงูุชูููุฉ

### Login Controller - ุงูุจููุฉ ุงูุฌุฏูุฏุฉ

```typescript
login: async (req, res) => {
  // Step 1: Validate input
  // Step 2: Authenticate with Supabase Auth
  // Step 3: Ensure user record exists
  // Step 4: Get user data from database
  // Step 5: Determine user role
  // Step 6: Set auth cookies
  // Step 7: Return success response
}
```

### ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

```typescript
// ุฎุทุฃ ูู ุงููุตุงุฏูุฉ
if (authError) {
  return res.status(401).json({
    error: { code: 'INVALID_CREDENTIALS', message: ... }
  });
}

// ุฎุทุฃ ูู ุงูุจูุงูุงุช
if (!authData?.user || !authData?.session) {
  return res.status(500).json({
    error: { code: 'AUTH_FAILED', message: ... }
  });
}
```

---

## ๐ ููุงุฑูุฉ ุงูุฃุฏุงุก

| ุงููููุงุณ | ูุจู | ุจุนุฏ |
|---------|-----|-----|
| ุนุฏุฏ ุงูุฃุณุทุฑ | ~350 | ~200 |
| ุงูุชุนููุฏ | ุนุงูู | ููุฎูุถ |
| ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก | ูุนูุฏุฉ | ุจุณูุทุฉ |
| ุงูููุซูููุฉ | ูุชูุณุทุฉ | ุนุงููุฉ |

---

## ๐ ุงูุฃูุงู

### RLS Policies ุนูู Sessions

```sql
-- ุงููุณุชุฎุฏููู ูุฑูู ุฌูุณุงุชูู ููุท
CREATE POLICY "Users can view their own sessions"
  ON public.sessions FOR SELECT
  USING (auth.uid() = user_id);

-- Service role ูู ุตูุงุญูุงุช ูุงููุฉ
CREATE POLICY "Service role has full access"
  ON public.sessions FOR ALL
  USING (auth.jwt()->>'role' = 'service_role');
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุญุงูุงุช ุงูุงุฎุชุจุงุฑ:

1. โ ุชุณุฌูู ุฏุฎูู ูุงุฌุญ
2. โ ุชุณุฌูู ุฏุฎูู ุจุจูุงูุงุช ุฎุงุทุฆุฉ
3. โ ุชุณุฌูู ุฏุฎูู ุจุฏูู user record (ูุชู ุฅูุดุงุคู ุชููุงุฆูุงู)
4. โ ุชุณุฌูู ุฏุฎูู ูุน role ูุฎุชูู
5. โ ูุนุงูุฌุฉ ุฃุฎุทุงุก Supabase Auth
6. โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 2FA
- ุชู ุชุนุทูู ูุญุต 2FA ูุคูุชุงู ููุชุจุณูุท
- ูููู ุฅุนุงุฏุฉ ุชูุนููู ูุงุญูุงู ุนูุฏ ุงูุญุงุฌุฉ

### User Record
- ูุชู ุฅูุดุงุก user record ุชููุงุฆูุงู ุฅุฐุง ูู ููู ููุฌูุฏุงู
- ูุณุชุฎุฏู `ensureUserRecord` ูู middleware

### Role Determination
- ุณูุณูุฉ fallback ูุงุถุญุฉ:
  1. userRecord.role
  2. userData.role (ูู DB)
  3. user_metadata.role
  4. 'investor' (ุงูุชุฑุงุถู)

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. โ ุงุฎุชุจุงุฑ ุชุณุฌูู ุงูุฏุฎูู
2. โณ ุงุฎุชุจุงุฑ refresh token
3. โณ ุงุฎุชุจุงุฑ logout
4. โณ ุงุฎุชุจุงุฑ 2FA (ุนูุฏ ุฅุนุงุฏุฉ ุงูุชูุนูู)

---

## ๐ ุงููุฑุงุฌุน

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Supabase RLS Documentation](https://supabase.com/docs/guides/auth/row-level-security)
- [MCP Supabase Tools](../SUPABASE_MCP_STEPS.md)

