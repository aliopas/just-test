# ุฏููู ุงุฎุชุจุงุฑ Story 3.4: ุฑูุน ุงููููุงุช ูุน Presigned URLs

**ุงูุชุงุฑูุฎ:** 2025-01-17  
**ุงูุญุงูุฉ:** ๐ ุฏููู ุงุฎุชุจุงุฑ ุดุงูู

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช ุงูุขููุฉ (Backend)

### 1. ุงุฎุชุจุงุฑุงุช Controller

**ุงูููู:** `backend/tests/request.controller.test.ts`

#### ุงุฎุชุจุงุฑุงุช ูุทููุจุฉ:

```typescript
describe('requestController.presignAttachment', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('returns 401 when user not authenticated', async () => {
    // Test: ูุฌุจ ุฃู ูุนูุฏ 401 ุนูุฏ ุนุฏู ูุฌูุฏ user
  });

  it('returns 400 when request id is missing', async () => {
    // Test: ูุฌุจ ุฃู ูุนูุฏ 400 ุนูุฏ ุนุฏู ูุฌูุฏ requestId
  });

  it('returns 400 when validation fails', async () => {
    // Test: ูุฌุจ ุฃู ูุนูุฏ 400 ุนูุฏ ูุดู ุงูุชุญูู ูู ุงูุจูุงูุงุช
  });

  it('returns 404 when request not found', async () => {
    // Test: ูุฌุจ ุฃู ูุนูุฏ 404 ุนูุฏ ุนุฏู ูุฌูุฏ ุงูุทูุจ
  });

  it('returns 403 when request not owned by user', async () => {
    // Test: ูุฌุจ ุฃู ูุนูุฏ 403 ุนูุฏ ูุญุงููุฉ ุฑูุน ููู ูุทูุจ ููุณ ูููุณุชุฎุฏู
  });

  it('returns 409 when request is not editable', async () => {
    // Test: ูุฌุจ ุฃู ูุนูุฏ 409 ุนูุฏ ูุญุงููุฉ ุฑูุน ููู ูุทูุจ ุบูุฑ ูุงุจู ููุชุนุฏูู
  });

  it('returns presign URL on success', async () => {
    // Test: ูุฌุจ ุฃู ูุนูุฏ Presigned URL ุนูุฏ ุงููุฌุงุญ
  });
});
```

### 2. ุงุฎุชุจุงุฑุงุช Service

**ุงูููู:** `backend/tests/request.service.test.ts` (ุฅูุดุงุก ุฌุฏูุฏ)

#### ุงุฎุชุจุงุฑุงุช ูุทููุจุฉ:

```typescript
describe('createRequestAttachmentUploadUrl', () => {
  it('creates presigned URL successfully', async () => {
    // Test: ุฅูุดุงุก Presigned URL ุจูุฌุงุญ
  });

  it('validates file type', async () => {
    // Test: ุงูุชุญูู ูู ููุน ุงูููู (PDF, JPG, PNG ููุท)
  });

  it('validates file size', async () => {
    // Test: ุงูุชุญูู ูู ุญุฌู ุงูููู (โค 10MB)
  });

  it('creates attachment record in database', async () => {
    // Test: ุฅูุดุงุก ุณุฌู ูู ุฌุฏูู attachments
  });

  it('throws error when request not found', async () => {
    // Test: ุฎุทุฃ ุนูุฏ ุนุฏู ูุฌูุฏ ุงูุทูุจ
  });

  it('throws error when request not owned', async () => {
    // Test: ุฎุทุฃ ุนูุฏ ุนุฏู ููููุฉ ุงูุทูุจ
  });

  it('throws error when request not editable', async () => {
    // Test: ุฎุทุฃ ุนูุฏ ุนุฏู ุฅููุงููุฉ ุงูุชุนุฏูู
  });
});
```

---

## ๐ฑ๏ธ ุงูุงุฎุชุจุงุฑุงุช ุงููุฏููุฉ (Frontend)

### 1. ุงุฎุชุจุงุฑ ุณูุฑ ุงูุนูู ุงูุฃุณุงุณู

#### ุงูุณููุงุฑูู 1: ุฑูุน ููู PDF ุจุนุฏ ุฅูุดุงุก ุงูุทูุจ

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ุตูุญุฉ "ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ"
2. ุงููุฃ ุงููููุฐุฌ:
   - ุงูููุน: ุดุฑุงุก
   - ุนุฏุฏ ุงูุฃุณูู: 10
   - ุงูููุงุญุธุงุช: (ุงุฎุชูุงุฑู)
3. ุงุถุบุท "ุฅุฑุณุงู"
4. ุจุนุฏ ุฅูุดุงุก ุงูุทูุจุ ูุฌุจ ุฃู ูุธูุฑ:
   - โ ุฑุณุงูุฉ ูุฌุงุญ
   - โ ุชูุนูู ููุทูุฉ ุฑูุน ุงููููุงุช
   - โ ุฑุณุงูุฉ "ุณูุชู ุฑูุน ุงููููุงุช ุจุนุฏ ุฅูุดุงุก ุงูุทูุจ" ุชุฎุชูู
5. ุงุฎุชุฑ ููู PDF (ุญุฌู < 10MB)
6. ุฑุงูุจ ุญุงูุฉ ุงูุฑูุน:
   - โณ ูุฌุจ ุฃู ูุธูุฑ "uploading"
   - โ ูุฌุจ ุฃู ูุชุญูู ุฅูู "success" ุจุนุฏ ุงูุฑูุน
7. ุชุญูู ูู:
   - โ ุงูููู ูุธูุฑ ูู ุงููุงุฆูุฉ
   - โ ุญุฌู ุงูููู ุตุญูุญ
   - โ ุงููููุฐุฌ ูุชู ุฅุนุงุฏุฉ ุชุนูููู ุจุนุฏ ุงูุฑูุน

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ูุฌุงุญ

---

#### ุงูุณููุงุฑูู 2: ุฑูุน ููู ุตูุฑุฉ (JPG/PNG)

**ุงูุฎุทูุงุช:**
1. ูุฑุฑ ุงูุฎุทูุงุช 1-4 ูู ุงูุณููุงุฑูู 1
2. ุงุฎุชุฑ ููู ุตูุฑุฉ (JPG ุฃู PNG)
3. ุฑุงูุจ ุนูููุฉ ุงูุฑูุน

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ูุฌุงุญ

---

#### ุงูุณููุงุฑูู 3: ุฑูุน ุนุฏุฉ ูููุงุช

**ุงูุฎุทูุงุช:**
1. ูุฑุฑ ุงูุฎุทูุงุช 1-4 ูู ุงูุณููุงุฑูู 1
2. ุงุฎุชุฑ ุนุฏุฉ ูููุงุช (PDF + JPG + PNG)
3. ุฑุงูุจ ุฑูุน ุฌููุน ุงููููุงุช

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ุฌููุน ุงููููุงุช ุชูุฑูุน ุจูุฌุงุญ

---

#### ุงูุณููุงุฑูู 4: Drag & Drop

**ุงูุฎุทูุงุช:**
1. ูุฑุฑ ุงูุฎุทูุงุช 1-4 ูู ุงูุณููุงุฑูู 1
2. ุงุณุญุจ ูููุงุช ูุฃููุชูุง ูู ููุทูุฉ ุงูุฑูุน
3. ุฑุงูุจ ุนูููุฉ ุงูุฑูุน

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ุงูุฑูุน ูุนูู ูุน Drag & Drop

---

### 2. ุงุฎุชุจุงุฑ ุงูุชุญูู ูู ุงูุฃุฎุทุงุก

#### ุงูุณููุงุฑูู 5: ููู ุจุญุฌู > 10MB

**ุงูุฎุทูุงุช:**
1. ูุฑุฑ ุงูุฎุทูุงุช 1-4 ูู ุงูุณููุงุฑูู 1
2. ุญุงูู ุฑูุน ููู ุจุญุฌู > 10MB

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ูุฌุจ ุฃู ููุดู ูุน ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ

**ุงูุฑุณุงูุฉ ุงููุชููุนุฉ:**
- ุงูุนุฑุจูุฉ: "ุญุฌู ุงูููู ูุฌุจ ุฃู ูููู ุฃูู ูู 10MB"
- English: "File size must be less than 10MB"

---

#### ุงูุณููุงุฑูู 6: ููู ุจููุน ุบูุฑ ูุฏุนูู

**ุงูุฎุทูุงุช:**
1. ูุฑุฑ ุงูุฎุทูุงุช 1-4 ูู ุงูุณููุงุฑูู 1
2. ุญุงูู ุฑูุน ููู ุจููุน ุบูุฑ ูุฏุนูู (ูุซู .docx, .txt)

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ูุฌุจ ุฃู ููุดู ูุน ุฑุณุงูุฉ ุฎุทุฃ

**ุงูุฑุณุงูุฉ ุงููุชููุนุฉ:**
- ุงูุนุฑุจูุฉ: "ููุน ุงูููู ุบูุฑ ูุฏุนูู. ููุณูุญ ููุท ุจู PDF, JPG, PNG"
- English: "File type not supported. Only PDF, JPG, PNG are allowed"

---

#### ุงูุณููุงุฑูู 7: ุฅุฒุงูุฉ ููู ูุงุดู

**ุงูุฎุทูุงุช:**
1. ูุฑุฑ ุงูุฎุทูุงุช 1-4 ูู ุงูุณููุงุฑูู 1
2. ุญุงูู ุฑูุน ููู ูุงุดู (ุญุฌู ูุจูุฑ ุฃู ููุน ุบูุฑ ูุฏุนูู)
3. ุงุถุบุท ุฒุฑ "ร" ูุฅุฒุงูุฉ ุงูููู

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ูุฌุจ ุฃู ููุฒุงู ุงูููู ูู ุงููุงุฆูุฉ

---

### 3. ุงุฎุชุจุงุฑ ุงูุญุงูุงุช ุงูุญุฏูุฉ

#### ุงูุณููุงุฑูู 8: ุฑูุน ููู ูุจู ุฅูุดุงุก ุงูุทูุจ

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ุตูุญุฉ "ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ"
2. ุญุงูู ุฑูุน ููู ูุจู ููุก ุงููููุฐุฌ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ๏ธ ูุฌุจ ุฃู ุชููู ููุทูุฉ ุงูุฑูุน ูุนุทูุฉ ูุน ุฑุณุงูุฉ ุชูุถูุญูุฉ

**ุงูุฑุณุงูุฉ ุงููุชููุนุฉ:**
- ุงูุนุฑุจูุฉ: "ุณูุชู ุฑูุน ุงููููุงุช ุจุนุฏ ุฅูุดุงุก ุงูุทูุจ"
- English: "Files will be uploaded after creating the request"

---

#### ุงูุณููุงุฑูู 9: ุฑูุน ููู ุจุนุฏ ุฅุฑุณุงู ุงูุทูุจ

**ุงูุฎุทูุงุช:**
1. ุฃูุดุฆ ุทูุจุงู ูุงุฑูุน ูููุงู
2. ุจุนุฏ ุงูุชูุงู ุงูุฑูุนุ ุญุงูู ุฑูุน ููู ุขุฎุฑ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ูุฌุจ ุฃู ูุนูู ุจุดูู ุทุจูุนู (ุฅุฐุง ูุงู ุงูุทูุจ ูู ุญุงูุฉ draft ุฃู submitted)

---

### 4. ุงุฎุชุจุงุฑ RTL/LTR

#### ุงูุณููุงุฑูู 10: ูุงุฌูุฉ ุนุฑุจูุฉ

**ุงูุฎุทูุงุช:**
1. ุบููุฑ ุงููุบุฉ ุฅูู ุงูุนุฑุจูุฉ
2. ุงุชุจุน ุงูุณููุงุฑูู 1

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ุฌููุน ุงููุตูุต ุจุงูุนุฑุจูุฉุ ุงูุงุชุฌุงู RTL

---

#### ุงูุณููุงุฑูู 11: ูุงุฌูุฉ ุฅูุฌููุฒูุฉ

**ุงูุฎุทูุงุช:**
1. ุบููุฑ ุงููุบุฉ ุฅูู ุงูุฅูุฌููุฒูุฉ
2. ุงุชุจุน ุงูุณููุงุฑูู 1

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ุฌููุน ุงููุตูุต ุจุงูุฅูุฌููุฒูุฉุ ุงูุงุชุฌุงู LTR

---

## ๐ ุงูุชุญูู ูู Backend

### 1. ุงูุชุญูู ูู Database

ุจุนุฏ ุฑูุน ูููุ ุชุญูู ูู:

```sql
-- ุงูุชุญูู ูู ูุฌูุฏ ุงูุณุฌู ูู ุฌุฏูู attachments
SELECT * FROM attachments 
WHERE request_id = '<request_id>'
ORDER BY created_at DESC;

-- ูุฌุจ ุฃู ูุญุชูู ุนูู:
-- - id (UUID)
-- - request_id
-- - filename
-- - mime_type
-- - size
-- - storage_key
-- - created_at
```

### 2. ุงูุชุญูู ูู Supabase Storage

1. ุงูุชุญ Supabase Dashboard
2. ุงุฐูุจ ุฅูู Storage โ Buckets โ `request-attachments`
3. ุชุญูู ูู ูุฌูุฏ ุงููููุงุช ุงููุฑููุนุฉ ูู ุงููุณุงุฑ:
   - `{request_id}/{year}/{month}/{uuid}.{ext}`

---

## ๐ ูุงุฆูุฉ ุงูุชุญูู ุงูุดุงููุฉ

### Backend Tests
- [ ] Unit tests ูู `presignAttachment` controller
- [ ] Unit tests ูู `createRequestAttachmentUploadUrl` service
- [ ] Integration tests ูุณูุฑ ุงูุนูู ุงููุงูู
- [ ] Error handling tests

### Frontend Tests
- [ ] Unit tests ูู `useRequestAttachment` hook
- [ ] Unit tests ูู `UploadDropzone` component
- [ ] Integration tests ูู `NewRequestForm`

### Manual Tests
- [ ] ุฑูุน ููู PDF
- [ ] ุฑูุน ููู JPG
- [ ] ุฑูุน ููู PNG
- [ ] ุฑูุน ุนุฏุฉ ูููุงุช
- [ ] Drag & Drop
- [ ] ููู ุจุญุฌู > 10MB (ูุฌุจ ุฃู ููุดู)
- [ ] ููู ุจููุน ุบูุฑ ูุฏุนูู (ูุฌุจ ุฃู ููุดู)
- [ ] ุฅุฒุงูุฉ ููู ูุงุดู
- [ ] ุฑูุน ููู ูุจู ุฅูุดุงุก ุงูุทูุจ (ูุฌุจ ุฃู ูููู ูุนุทูุงู)
- [ ] RTL/LTR support
- [ ] ุฑุณุงุฆู ุงูุฎุทุฃ ูุงุถุญุฉ

### Database Verification
- [ ] ุงูุณุฌูุงุช ุชููุดุฃ ูู ุฌุฏูู `attachments`
- [ ] ุงููููุงุช ุชูุฑูุน ุฅูู Supabase Storage
- [ ] `storage_key` ุตุญูุญ

---

## ๐ ุงููุดุงูู ุงููุญุชููุฉ ูุญููููุง

### ุงููุดููุฉ 1: ุงููููุงุช ูุง ุชูุฑูุน
**ุงูุญู:**
- ุชุญูู ูู `requestId` ููุฌูุฏ
- ุชุญูู ูู Presigned URL ุตุญูุญ
- ุชุญูู ูู Headers ุตุญูุญุฉ
- ุชุญูู ูู CORS settings ูู Supabase

### ุงููุดููุฉ 2: ุฑุณุงุฆู ุงูุฎุทุฃ ุบูุฑ ูุงุถุญุฉ
**ุงูุญู:**
- ุชุญูู ูู Error handling ูู `uploadFile` function
- ุชุญูู ูู Toast messages

### ุงููุดููุฉ 3: ุงููููุงุช ูุง ุชุธูุฑ ูู Request Details
**ุงูุญู:**
- ุชุญูู ูู `getInvestorRequestDetail` service
- ุชุญูู ูู Signed Download URLs

---

## โ ูุนุงููุฑ ุงููุฌุงุญ

### ูุฌุจ ุฃู ูุนูู:
- โ ุฑูุน ูููุงุช PDF, JPG, PNG
- โ ุงูุชุญูู ูู ููุน ุงูููู ูุญุฌูู
- โ ุนุฑุถ ุญุงูุฉ ุงูุฑูุน ูู ุงูููุช ุงููุนูู
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ููุงุณุจ
- โ RTL/LTR support
- โ Drag & Drop

### ูุฌุจ ุฃู ููุดู ุจุดูู ุตุญูุญ:
- โ ูููุงุช ุจุญุฌู > 10MB
- โ ูููุงุช ุจููุน ุบูุฑ ูุฏุนูู
- โ ุฑูุน ูููุงุช ูุจู ุฅูุดุงุก ุงูุทูุจ

---

## ๐ ููุงุญุธุงุช ุงูุงุฎุชุจุงุฑ

### ุจูุฆุฉ ุงูุงุฎุชุจุงุฑ:
- **Backend:** `npm test -- request.controller.test.ts`
- **Frontend:** Manual testing ูู ุงููุชุตูุญ
- **Database:** Supabase Dashboard

### ุงูุจูุงูุงุช ุงููุทููุจุฉ:
- ุญุณุงุจ ูุณุชุฎุฏู ูุณุฌู
- ุทูุจ ูู ุญุงูุฉ `draft` ุฃู `submitted`
- ูููุงุช ุงุฎุชุจุงุฑ (PDF, JPG, PNG ุจุฃุญุฌุงู ูุฎุชููุฉ)

---

**ุชู ุงูุฅูุดุงุก ุจูุงุณุทุฉ:** AI Assistant  
**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2025-01-17  
**ุขุฎุฑ ุชุญุฏูุซ:** 2025-01-17

