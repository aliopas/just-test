# Story 3.2: ุฅูุดุงุก State Machine ูุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ โ ุญุงูุฉ ุงูุฅููุงู

**ุงูุชุงุฑูุฎ:** 2025-11-08  
**ุงูุญุงูุฉ:** โ ููุชูู

---

## โ ูุง ุชู ุฅูุฌุงุฒู

### 1. ุชุนุฑูู ุงูุญุงูุงุช ูุงูุชุญููุงุช
- ุงูุญุงูุงุช ุงููุฏุนููุฉ: `draft`, `submitted`, `screening`, `pending_info`, `compliance_review`, `approved`, `rejected`, `settling`, `completed`.
- ุชู ุชุญุฏูุฏ ุงูุชุญููุงุช ุงููุณููุญุฉ ูู `backend/src/services/request-state.service.ts` ูู ุฎูุงู ุฎุฑูุทุฉ ูุงุถุญุฉ (State Machine).
- ุฃู ูุญุงููุฉ ุงูุชูุงู ุบูุฑ ูุตุฑุญ ุจูุง ุชูุฑูุถ ูุน ุฑุณุงูุฉ ุชูุถูุญูุฉ.

### 2. ููุทู ุงูุชุญูู ูุงูุชูููุฐ
- ุงูุฏูุงู ุงููุตุฏูุฑุฉ:
  - `getAllowedTransitions(status)` ูุฅุฑุฌุงุน ุงูุชุญููุงุช ุงููุณููุญุฉ.
  - `canTransition(from, to)` ู `assertTransition(from, to)` ููุงุณุชุฎุฏุงู ุงูุณุฑูุน ูู ุงูุฎุฏูุงุช ุงูุฃุฎุฑู.
  - `transitionRequestStatus(options)`:
    - ุชุชุญูู ูู ุงูุญุงูุฉ ุงูุญุงููุฉ ููุทูุจ.
    - ุชุถูู ุชูุงูู ุงูุชุญูู ูุน ุงูู State Machine.
    - ุชุญุฏูุซ ุงูุญูู `status` ูู ุฌุฏูู `requests`.
    - ุชุณุฌูู ุญุฏุซูุง ุฌุฏูุฏูุง ูู `request_events` ูุชุถูู ุงููููุฐ ูุงูููุงุญุธุฉ ูุงูุชูููุช.
    - ุชุฑุฌุน ููู ูู ุงูุทูุจ ุงููุญุฏูุซ ูุณุฌู ุงูุญุฏุซ ุนูุฏ ุงููุฌุงุญ.

### 3. ุงูุชูุงูู ูุน Supabase
- ุชุณุชุฎุฏู ุงูุฎุฏูุฉ Supabase Admin Client (`requireSupabaseAdmin`) ูุฅุฌุฑุงุก ุงูุนูููุงุช ุงูุฐุฑูุฉ ุนูู ุงูุฌุฏุงูู.
- ุชุณุฌูู ุงูุญุฏุซ ููุนูุฏ ุงูุณุฌู ุงููุงุชุฌ ูุถูุงู ุฅููุงููุฉ ุงูุงุณุชุฎุฏุงู ูุงุญููุง ูู ุณูุฑ ุงูุนูู.
- ุชูุช ุฅุถุงูุฉ ุญูุงูุฉ ููููุงุญุธุงุช (truncate ุฅูู 500 ุญุฑู) ูููุน ุฅุฏุฎุงู ุจูุงูุงุช ูุจุงูุบ ุจูุง.

### 4. ุงูุชุบุทูุฉ ุงูุงุฎุชุจุงุฑูุฉ
- `backend/tests/request-state.service.test.ts` ูุบุทู:
  - ุงูุชุญูู ูู ุงูุฌุฏุงูู ุงูุงูุชูุงููุฉ.
  - ุงูุชูุงู ูุงุฌุญ ูู `draft` ุฅูู `submitted` ูุชุณุฌูู ุงูุญุฏุซ.
  - ุฑูุถ ุงูุงูุชูุงู ุบูุฑ ุงููุณููุญ (`draft` โ `approved`).
- ูุชู Mock ูู Supabase Admin ูุถูุงู ูุญุฏุฉ ุงูุงุฎุชุจุงุฑ ุฏูู ุงูุงุชุตุงู ุจุงูุฎุฏูุฉ.

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช
| ุงูุฃูุฑ | ุงููุชูุฌุฉ |
|-------|---------|
| `npm test -- request-state.service.test.ts` | ุชูุฑ โ |
| `npm run lint` | ููุฑ โ |
| `npm run build` (ุณุงุจููุง ุฃุซูุงุก Story 3.1 ูุถูู ุงูุณูุณูุฉ ุงูุญุงููุฉ) | ููุฑ โ |

---

## ๐ ุงููููุงุช ุงูููุดุฃุฉ / ุงููุญุฏุซุฉ
- `backend/src/services/request-state.service.ts`
- `backend/tests/request-state.service.test.ts`
- `docs/stories/STORY_3.2_COMPLETION.md` (ูุฐุง ุงููุณุชูุฏ)

---

## ๐ ููุงุญุธุงุช
- ุงูุฎุฏูุฉ ุญุงููุงู ุชุณุชุฎุฏู Supabase Admin ูุถูุงู ูุงุจููุฉ ุฅุนุงุฏุฉ ุงูุงุณุชุฎุฏุงู ูู ูุจู ุงูุฃุฏูู ุฃู ุงูุฎุฏูุงุช ุงูุฎูููุฉุ ุนูุฏ ุจูุงุก ุงูู APIs ุณูุชู ุงูุชุญูู ูู ุงูุงุณุชุฏุนุงุก ุญุณุจ ุตูุงุญูุงุช ุงููุณุชุฎุฏู (Investor/Admin).
- ูุชู ุงูุงุนุชูุงุฏ ุนูู Story 3.1 (ุงูุฌุฏุงูู ูุงูุณูุงุณุงุช)ุ Story 3.3 ููุง ุจุนุฏูุง ุณุชุณุชููุฏ ูู ูุฐู ุงูุฎุฏูุฉ ูุงุณุชููุงู ุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ ุจุงููุงูู.

---

**ุชู ุงูุฅูุดุงุก ุจูุงุณุทุฉ:** GPT-5 Codex (Cursor)  
**ุขุฎุฑ ุชุญุฏูุซ:** 2025-11-08  

