# Story 2.4: ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู ูู ููุญุฉ ุงูุฃุฏูู โ ุญุงูุฉ ุงูุฅููุงู

**ุงูุชุงุฑูุฎ:** 2025-11-08  
**ุงูุญุงูุฉ:** โ ููุชูู

---

## โ ูุง ุชู ุฅูุฌุงุฒู

### 1. ุชูุณูุน ูุฎุทุท ุงูุจูุงูุงุช
- ุฅูุดุงุก ุงูุนุฑุถ `v_admin_users` (migration: `20241108070000_admin_users_view.sql`) ูุชุฌููุน ุจูุงูุงุช ุงููุณุชุฎุฏูุ ุงูุฃุฏูุงุฑุ ูุญุงูุฉ KYC ูู ูุตุฏุฑ ูุงุญุฏ ููุฃุฏูู.
- ุชุฃูุฏ ุงูุนุฑุถ ูู ุชุถููู `role_slugs`, `role_names`, `communication_preferences`ุ ูุจูุงูุงุช ุงูููู ุงูุงุณุชุซูุงุฑู.

### 2. ุจูุงุก ุทุจูุฉ ุงูุฎุฏูุฉ ููุฃุฏูู
- `adminUserService` ูููุฑ:
  - `listUsers` ูุน ุฏุนู pagination, filtering (status, role, kyc_status, ุงูุชุงุฑูุฎ), ูText search.
  - `updateUserStatus` ูุชุบููุฑ ุญุงูุฉ ุงููุณุชุฎุฏู ูุน ุฅุจุทุงู ุงูุฌูุณุงุช ูุฅูุดุงุก ุณุฌู ุชุฏููู.
  - `resetPassword` ุงูุฐู ููุดุฆ ุฑุงุจุท ุงุณุชุนุงุฏุฉ ุนุจุฑ Supabase Admin API ููุฑุตุฏ ุงูุญุฏุซ ูู `audit_logs`.
  - `createUser` ูุฅูุดุงุก ูุณุชุฎุฏู (Supabase Auth + ุฌุฏูู users) ูุชุนููู ุงูุฏูุฑ ูุงูููู ุงูุงุณุชุซูุงุฑู (communication defaults, metadata) ูุน ุฅุฑุณุงู ุฏุนูุฉ ุฃู ูููุฉ ูุฑูุฑ ูุคูุชุฉ.
- ุงุณุชุฎุฏุงู `diffObjects` ูุฅุฑูุงู ุงููุฑู ูู ูู ุนูููุฉ ุชุบููุฑ.

### 3. ุฅุถุงูุฉ Controller & Routes
- `adminUserController` ูุบูู ุฌููุน ุงููุณุงุฑุงุช ูุน ุงูุชุญูู ุจูุงุณุทุฉ Zod ูุณุฌูุงุช ุงูุฃุฎุทุงุก.
- REST Endpoints:
  - `GET /api/v1/admin/users` โ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ูุน metadata (page count, hasNext).
  - `PATCH /api/v1/admin/users/:id/status` โ ุชุบููุฑ ุงูุญุงูุฉ.
  - `POST /api/v1/admin/users/:id/reset-password` โ ุชูููุฏ ุฑุงุจุท ุงุณุชุนุงุฏุฉ.
  - `POST /api/v1/admin/users` โ ุฅูุดุงุก ูุณุชุฎุฏู ุฌุฏูุฏ (ูุณุชุซูุฑ ุฃู ุฅุฏุงุฑู).
- ุฌููุน ุงููุณุงุฑุงุช ูุญููุฉ ุจููุฏูููุฑ `authenticate` + `requirePermission('admin.users.manage')`.
- ุชู ุชุญุฏูุซ `backend/src/app.ts` ูุฅุถุงูุฉ `adminRouter`.

### 4. ุฏุนู ุงูุชุญูู ูุงูู RBAC
- ูุฎุทุท Zod ุดุงูู ูู `backend/src/schemas/admin-users.schema.ts` ูุดูู query parameters ูbody requests.
- ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู `rbacService.assignRole` ูุชุนููู ุงูุฏูุฑุ ูุน ูุณุฑ ุงูู cache ุงูุฎุงุต ุจุงูู RBAC ุชููุงุฆูุงู.
- ุชุณุฌูู ูู ุชุบููุฑ ูู `audit_logs` ูุฅุชุงุญุฉ ุงูุชุชุจุน (status change, reset password, create user).

### 5. ุงูุงุฎุชุจุงุฑุงุช
- ุฅูุดุงุก ุงุฎุชุจุงุฑ ูุญุฏุฉ `backend/tests/admin-users.controller.test.ts` ูุบุทู ุณููุงุฑูููุงุช ุงููุฌุงุญ/ุงููุดู ูููุญุฉ ุงูุฃุฏูู.
- ูุนุชูุฏ ุนูู Mocking ูู `adminUserService` ููุชุฃูุฏ ูู ุตุญุฉ ุงูู Controller ูุงูุฑุฏูุฏ.
- ุชู ุงูุชุฃูุฏ ูู ูุฑูุฑ ESLint ูTypeScript build.

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช
### Unit / Integration
| ุงูุฃูุฑ | ุงููุฎุฑุฌุงุช |
|-------|----------|
| `npm test -- admin-users.controller.test.ts` | ุชูุฑ โ |
| `npm run lint` | ููุฑ โ |
| `npm run build` | ููุฑ โ |

> ููุงุญุธุฉ: ุงุฎุชุจุงุฑุงุช ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุงูุฎุงุตุฉ ุจุงูุฃุฏูู ุณุชูุถุงู ุนูุฏ ุชุทููุฑ Story 2.5 (ูุงุฌูุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู).

---

## ๐ ุงููููุงุช ุงูููุดุฃุฉ / ุงููุญุฏุซุฉ

### ูููุงุช ุฌุฏูุฏุฉ
- `supabase/migrations/20241108070000_admin_users_view.sql`
- `backend/src/services/admin-user.service.ts`
- `backend/src/controllers/admin-user.controller.ts`
- `backend/src/routes/admin.routes.ts`
- `backend/src/schemas/admin-users.schema.ts`
- `backend/tests/admin-users.controller.test.ts`

### ูููุงุช ูุญุฏุซุฉ
- `backend/src/app.ts` โ ุชุณุฌูู ูุณุงุฑ `/api/v1/admin`.
- `backend/src/services/rbac.service.ts` โ ุงุณุชุฏุนุงุก ูุชุนููู ุงูุฏูุฑ ูู ุฅูุดุงุก ุงููุณุชุฎุฏู.
- `package-lock.json` ุจุนุฏ ุชุซุจูุช ุงูุชุจุนูุงุช (ุฅู ูุฌุฏุช).

---

## โ๏ธ ุชุจุนูุงุช / ุฅุนุฏุงุฏุงุช
- ุฅูุดุงุก ูุณุชุฎุฏู ุฌุฏูุฏ ูุนุชูุฏ ุนูู Supabase Admin APIุ ูุฐุง ูุฌุจ ุงูุชุฃูุฏ ูู ูุฌูุฏ `SUPABASE_SERVICE_ROLE_KEY`.
- ูู ูุนูู ุฅุฑุณุงู ุงูุจุฑูุฏ ุฃู SMS ูุนูููุง ุญุชู ูุชู ุฅุนุฏุงุฏ ูููุงุช ุงูุงุชุตุงู ูู Epic 6ุ ุชู ูุถุน TODO ููุชูุงูู ูุงุญููุง.
- Interfaces ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุณุชุญุตู ุนูู JSON ููุญุฏ ููุนุฑุถ ุนูุฏ ุชูููุฐ Story 2.5.

---

## ๐ ููุงุญุธุงุช
- `resetPassword` ูุนูุฏ `resetLink` ุงูุฐู ูููู ุงุณุชุฎุฏุงูู ูุงุญูุงู ูุฅุฑุณุงูู ุนุจุฑ ุงูุจุฑูุฏ/SMS.
- `communication_preferences` ููููู ุงูุงุณุชุซูุงุฑู ุชูุถุจุท ุนูู ุงูููู ุงูุงูุชุฑุงุถูุฉ (email: true, sms: false, push: true) ูุน ุฅููุงููุฉ ุชุนุฏูููุง ูุงุญููุง.
- ูู ุงูููู ุชุญุฏูุซ Story 2.5 ูุงุณุชุฎุฏุงู ุงูุนุฑุถ ุงูุฌุฏูุฏ `v_admin_users` ูุชุฌูุจ N+1 queries ุนูุฏ ุจูุงุก ูุงุฌูุฉ ุงูุฃุฏูู.

---

**ุชู ุงูุฅูุดุงุก ุจูุงุณุทุฉ:** GPT-5 Codex (Cursor)  
**ุขุฎุฑ ุชุญุฏูุซ:** 2025-11-08  

