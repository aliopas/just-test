# Story 2.2: ุฅูุดุงุก ููู ุดุฎุตู ูููุณุชุซูุฑ โ ุญุงูุฉ ุงูุฅููุงู

**ุงูุชุงุฑูุฎ:** 2025-11-08  
**ุงูุญุงูุฉ:** โ ููุชูู

---

## โ ูุง ุชู ุฅูุฌุงุฒู

### 1. ุฅูุดุงุก ุฌุฏูู `investor_profiles`
- ุชู ุฅูุดุงุก ุงููุฌุฑุฉ `20241108060000_investor_profiles.sql` ุนุจุฑ MCP.
- ุงูุฌุฏูู ูุชุถูู ุงูุญููู:
  - ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ (`full_name`, `preferred_name`, `id_type`, `id_number`, `id_expiry`)
  - ูุนูููุงุช ุงูุฌูุณูุฉ ูุงูุฅูุงูุฉ (`nationality`, `residency_country`, `city`)
  - ุญุงูุฉ KYC (`kyc_status`, `kyc_updated_at`)
  - ุงููุบุฉ (`language`) ูุน ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ `ar`
  - ุชูุถููุงุช ุงูุชูุงุตู (`communication_preferences` ูู JSONB ูุน ููู ุงูุชุฑุงุถูุฉ email=true, sms=false, push=true)
  - ูุณุชูู ุงููุฎุงุทุฑ (`risk_profile`)
  - ูุงุฆูุฉ ุงููุซุงุฆู (`kyc_documents` ูู JSONB)
  - ุญููู ุงูุชุชุจุน (`created_at`, `updated_at`) ูุน Trigger ููุชุญุฏูุซ ุงูุชููุงุฆู
- ุฅูุดุงุก ุงูููุงุฑุณ (`idx_investor_profiles_user_id`, `idx_investor_profiles_kyc_status`)
- ุฅุถุงูุฉ ุงูุฃููุงุน ENUM (`investor_id_type`, `investor_kyc_status`, `investor_language`, `investor_risk_profile`)

### 2. ุฅูุดุงุก ุงูุนุฑุถ `v_investor_profiles`
- ูุนุฑุถ ุจูุงูุงุช ุงูููู ุงูุดุฎุตู ูุน ุจูุงูุงุช ุงููุณุชุฎุฏู ุงููุฑุชุจุทุฉ (emailุ phoneุ statusุ created_at).

### 3. ุณูุงุณุงุช RLS
- ุชูุนูู RLS ุนูู ุงูุฌุฏูู.
- ุณูุงุณุงุช ุชูููู ุงููุณุชุซูุฑ ูู ูุฑุงุกุฉ/ุชุนุฏูู ุณุฌูู ููุท.
- ุณูุงุณุงุช ุชูููู ุงูุฃุฏูู (ุตูุงุญูุฉ `admin.users.manage`) ูู ูุฑุงุกุฉ ูุชุนุฏูู ุฃู ููู.

### 4. ุฎุฏูุฉ ุงูููู ุงูุดุฎุตู `investorProfileService`
- ุฏูุงู:
  - `getProfile(userId)` ู`getProfileRecord(userId)` ูุน ุชุทุจูุน ุชูุถููุงุช ุงูุชูุงุตู.
  - `upsertProfile(payload)` ูุน ุฅุนุงุฏุฉ ุชุญููู ุจูุงูุงุช ุงูุนุฑุถ.
  - `logAudit` ูุชุณุฌูู ุงูุชุบููุฑุงุช ูู ุฌุฏูู `audit_logs`.
- ุชุนุฑูู ุชูุถููุงุช ุงูุชูุงุตู ุงูุงูุชุฑุงุถูุฉ ูุชุทุจูุนูุง.

### 5. ูุญุฏุฉ ุงูุชุญูู ูุงููุงุฌูุฉ ุงูุจุฑูุฌูุฉ
- ุฅูุดุงุก `backend/src/controllers/investor-profile.controller.ts` ููุชุนุงูู ูุน GET/PATCH.
- ุฅูุดุงุก ุงููุณุงุฑ `backend/src/routes/investor.routes.ts` ูุชูุตููู ุนุจุฑ `app.ts`.
- ุฏุนู ุงูุฑุณุงุฆู ุงููุชุฑุฌูุฉ (`ar`/`en`) ุจุงุณุชุฎุฏุงู `i18n.util`.
- ุญุณุงุจ ุงููุฑู ุจูู ุงูุจูุงูุงุช ุงูุณุงุจูุฉ ูุงููุงุญูุฉ ุจุงุณุชุฎุฏุงู `diff.util`.
- ุชุณุฌูู ุงูุชุบููุฑุงุช ูู `audit_logs` ูุน ูุนูููุงุช ุงููุณุชุฎุฏู ูุนููุงู IP.

### 6. ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
- ุฅูุดุงุก `backend/src/schemas/investor-profile.schema.ts` ุจุงุณุชุฎุฏุงู Zod:
  - ุงูุชุญูู ูู ุตูุบ ุงูุญููู (ISO countryุ ุงูุชุงุฑูุฎุ ุงูุฃุณูุงุกโฆ)
  - ุถูุงู ุชูุฏูู ุญูู ูุงุญุฏ ุนูู ุงูุฃูู ูู PATCH.
  - ุงูุชุญูู ูู ุฃู `communicationPreferences` ุชุญุชูู ุนูู ููุงุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู.

### 7. ุงูุงุฎุชุจุงุฑุงุช
- ุฅุถุงูุฉ ุงุฎุชุจุงุฑ ูุญุฏุฉ `backend/tests/investor-profile.controller.test.ts` ูุบุทู:
  - ุญุงูุงุช ุนุฏู ุงููุตุงุฏูุฉ.
  - ุนุฏู ูุฌูุฏ ููู.
  - ุงูุงุณุชุฑุฌุงุน ุงููุงุฌุญ ุจุงููุบุชูู.
  - ุงูุชุญุฏูุซ ูุน ุชุณุฌูู ุงููุฑู.
  - ุงูุชุญุฏูุซ ุจุฏูู ุชุบููุฑ.

---

## โ ุญุงูุฉ ูุนุงููุฑ ุงููุจูู

| # | ุงููุนูุงุฑ | ุงูุญุงูุฉ |
|---|---------|--------|
| 1 | ุฅูุดุงุก ุฌุฏูู `investor_profiles` ุจุงุณุชุฎุฏุงู MCP | โ |
| 2 | ุงุณุชุฎุฏุงู Supabase Client ููุงุณุชุนูุงูุงุช | โ |
| 3 | ุฅูุดุงุก API `GET /investor/profile` | โ |
| 4 | ุฅูุดุงุก API `PATCH /investor/profile` | โ |
| 5 | ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ุงููุฏุฎูุฉ | โ |
| 6 | ุฏุนู ุงููุบุฉ (ุนุฑุจู/ุฅูุฌููุฒู) | โ |
| 7 | ุญูุธ ุชูุถููุงุช ุงูุชูุงุตู | โ |
| 8 | ุงุณุชุฎุฏุงู RLS ูุญูุงูุฉ ุงูุจูุงูุงุช | โ |
| 9 | ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุชูุฑ ุจูุฌุงุญ | โ |

---

## ๐ ุงููููุงุช ุงูููุดุฃุฉ / ุงููุญุฏุซุฉ

### ูููุงุช ุฌุฏูุฏุฉ
- `supabase/migrations/20241108060000_investor_profiles.sql`
- `backend/src/controllers/investor-profile.controller.ts`
- `backend/src/routes/investor.routes.ts`
- `backend/src/schemas/investor-profile.schema.ts`
- `backend/src/services/investor-profile.service.ts`
- `backend/src/utils/diff.util.ts`
- `backend/src/utils/i18n.util.ts`
- `backend/tests/investor-profile.controller.test.ts`
- `docs/prd/rbac-matrix.md` (ุชูุช ุฅุถุงูุชูุง ุฃุซูุงุก Story 2.1 ููุฑุชุจุท ุงุณุชุฎุฏุงููุง ููุง)

### ูููุงุช ูุญุฏุซุฉ
- `backend/src/app.ts` โ ุฅุถุงูุฉ ูุณุงุฑ ุงููุณุชุซูุฑูู.
- `README.md` โ ุชุญุฏูุซ ุฑูุงุจุท ุงูุชูุซูู (RBAC Matrix).
- `supabase/migrations/20241108050000_rbac_refactor.sql` โ ุณูุงุณุงุช ุฅุถุงููุฉ.
- `backend/src/middleware/auth.middleware.ts`, `backend/src/middleware/rbac.middleware.ts`, `backend/src/services/rbac.service.ts` โ ุชุญุฏูุซุงุช Story 2.1 ุงููุชุนููุฉ ุจุงูุตูุงุญูุงุช.

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช

```bash
npm test -- investor-profile.controller.test.ts
npm test -- rbac.service.test.ts
```

ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฑุช ุจูุฌุงุญ.

---

## ๐ ููุงุญุธุงุช ุฃูููุฉ
- ุชู ุงูุงุนุชูุงุฏ ุนูู ุณูุงุณุงุช RLS ูุถูุงู ุฃู ุงููุณุชุซูุฑ ูุง ููููู ุงููุตูู ุณูู ูุจูุงูุงุชู.
- ุชูุช ุญูุงูุฉ ููุงุท ุงูููุงูุฉ ุจุตูุงุญูุงุช `investor.profile.read` ู `investor.profile.update`ุ ูุน ุชูููู ุงูุฃุฏูู ุนุจุฑ `admin.users.manage`.
- ุชุถูู ุณุฌูุงุช ุงูุชุฏููู ุงูุงุญุชูุงุธ ุจุชุบูุฑุงุช ุงูุจูุงูุงุช ุงููุงูุฉ ูุน ูุนูููุงุช ูููุฐ ุงูุนูููุฉ ูุนููุงู IP.

---

## ๐ฏ ุงูุฎุทูุฉ ุงูุชุงููุฉ

ุงูุงูุชูุงู ุฅูู **Story 2.3** ูุฅูุดุงุก ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงูุฎุงุตุฉ ุจุงูููู ุงูุดุฎุตู ูููุณุชุซูุฑุ ูุน ุงุณุชููุงู ุงูููุงุท ุงูููุงุฆูุฉ ุงูุฌุฏูุฏุฉ ูุชุฌุฑุจุฉ ุงูุชุฑุฌูุฉ ูุชูุถููุงุช ุงูุชูุงุตู ูุนูููุง.

