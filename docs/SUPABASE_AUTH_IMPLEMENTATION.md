# ูุธุงู ุชุณุฌูู ุงูุฏุฎูู ูุน Supabase - ุงูุชูุซูู ุงููุงูู

**ุงูุชุงุฑูุฎ:** 2025-01-16  
**ุงูุญุงูุฉ:** โ ููุชูู

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุนุงุฏุฉ ุจูุงุก ูุธุงู ุชุณุฌูู ุงูุฏุฎูู ุจุงููุงูู ููุนูู ูุจุงุดุฑุฉ ูุน Supabase Authุ ููุง ูุฌุนู ุงููุธุงู ุฃุจุณุท ูุฃูุซุฑ ููุซูููุฉ ูุฃุณูู ูู ุงูุตูุงูุฉ.

---

## ๐ฏ ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1. ุงุณุชุฎุฏุงู Supabase Auth ูุจุงุดุฑุฉ โ
- ูุง ุญุงุฌุฉ ููุงุนุชูุงุฏ ุนูู Backend API ูุชุณุฌูู ุงูุฏุฎูู
- ุงุณุชุฎุฏุงู `signInWithPassword` ูู Supabase ูุจุงุดุฑุฉ
- ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช ุชููุงุฆูุงู ูู ูุจู Supabase
- ุชุญุฏูุซ ุญุงูุฉ ุงููุตุงุฏูุฉ ูู ุงูููุช ุงููุนูู

### 2. Hook ูุจุณุท (`useSupabaseLogin`) โ
- Hook ูุงุญุฏ ูุชุณุฌูู ุงูุฏุฎูู
- ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ
- ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ
- ุชุญุฏูุซ ุชููุงุฆู ูุญุงูุฉ ุงููุณุชุฎุฏู

### 3. ุชูุงูู ูุน AuthContext โ
- ูุฒุงููุฉ ุชููุงุฆูุฉ ูุน Supabase Auth
- ุงูุญุตูู ุนูู role ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุชุฎุฒูู ูุคูุช ูู localStorage
- ุงุณุชุนุงุฏุฉ ุญุงูุฉ ุงููุณุชุฎุฏู ุนูุฏ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ

---

## ๐ ุงููููุงุช ุงูุฌุฏูุฏุฉ

### 1. `frontend/src/hooks/useSupabaseLogin.ts`
Hook ุฌุฏูุฏ ูุชุณุฌูู ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู Supabase ูุจุงุดุฑุฉ.

**ุงูุงุณุชุฎุฏุงู:**
```typescript
import { useSupabaseLogin } from '../hooks/useSupabaseLogin';

function LoginPage() {
  const loginMutation = useSupabaseLogin();
  
  const handleLogin = async () => {
    try {
      await loginMutation.mutateAsync({
        email: 'user@example.com',
        password: 'password123'
      });
      // ุณูุชู ุงูุชูุฌูู ุชููุงุฆูุงู ูู onSuccess
    } catch (error) {
      // ูุนุงูุฌุฉ ุงูุฎุทุฃ
    }
  };
}
```

**ุงููููุฒุงุช:**
- โ ุชุณุฌูู ุงูุฏุฎูู ูุจุงุดุฑุฉ ูุน Supabase
- โ ุงูุญุตูู ุนูู role ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุชุญุฏูุซ AuthContext ุชููุงุฆูุงู
- โ ุงูุชูุฌูู ุงูุชููุงุฆู ุญุณุจ ุงูุฏูุฑ
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ

### 2. `frontend/src/hooks/useSupabaseLogout.ts`
Hook ูุชุณุฌูู ุงูุฎุฑูุฌ ุจุงุณุชุฎุฏุงู Supabase.

**ุงูุงุณุชุฎุฏุงู:**
```typescript
import { useSupabaseLogout } from '../hooks/useSupabaseLogout';

function LogoutButton() {
  const logoutMutation = useSupabaseLogout();
  
  const handleLogout = () => {
    logoutMutation.mutate();
  };
}
```

---

## ๐ ุงูุชุฏูู ุงููุงูู ูุชุณุฌูู ุงูุฏุฎูู

### ุงูุฎุทูุงุช:

1. **ุงููุณุชุฎุฏู ูุฏุฎู ุงูุจูุงูุงุช**
   - Email ู Password
   - ุงูุชุญูู ูู ุงูุญููู ุงููุทููุจุฉ

2. **ุงุณุชุฏุนุงุก Supabase Auth**
   ```typescript
   await supabase.auth.signInWithPassword({
     email: credentials.email.trim(),
     password: credentials.password,
   });
   ```

3. **ุงูุญุตูู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู**
   - ุงูุญุตูู ุนูู user ู session ูู Supabase
   - ุฌูุจ role ูู ุฌุฏูู `users` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - Fallback ุฅูู metadata ุฅุฐุง ูู ููู role ููุฌูุฏุงู

4. **ุชุญุฏูุซ AuthContext**
   ```typescript
   setUser({
     id: data.user.id,
     email: data.user.email || '',
     role: userRole,
   });
   ```

5. **ุงูุชูุฌูู ุงูุชููุงุฆู**
   - Admin โ `/admin/dashboard`
   - Investor โ `/dashboard`
   - ุฃู ุฅูู ุงููุณุงุฑ ุงููุญููุธ ูู `sessionStorage`

---

## ๐ ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช

### Supabase ูุฏูุฑ ุงูุฌูุณุงุช ุชููุงุฆูุงู:
- โ ุชุฎุฒูู ุงูุฌูุณุฉ ูู localStorage
- โ ุชุญุฏูุซ ุชููุงุฆู ููู tokens
- โ ุฅุฏุงุฑุฉ ุงูุชูุงุก ุงูุตูุงุญูุฉ
- โ ุชุญุฏูุซ ุญุงูุฉ ุงููุตุงุฏูุฉ ูู ุงูููุช ุงููุนูู

### AuthContext ูุฒุงูู ูุน Supabase:
- โ ูุฑุงุกุฉ ุงูุฌูุณุฉ ูู Supabase ุนูุฏ ุงูุชุญููู
- โ ุงูุงุณุชูุงุน ูุชุบููุฑุงุช ุญุงูุฉ ุงููุตุงุฏูุฉ
- โ ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏู ุชููุงุฆูุงู

---

## ๐๏ธ ุงูุชูุงูู ูุน ุงููุธุงู ุงูุญุงูู

### Backend API (ุงุฎุชูุงุฑู)
- ูููู ุงุณุชุฎุฏุงู Backend API ููุนูููุงุช ุงูุฅุถุงููุฉ
- ุชุณุฌูู ุงูุฏุฎูู ุงูุฃุณุงุณู ูุนูู ูุจุงุดุฑุฉ ูุน Supabase
- Backend ูุชุงุญ ููุนูููุงุช ุงููุนูุฏุฉ (2FAุ ุฅูุฎ)

### RLS Policies
- ุฌููุน ุงูุฌุฏุงูู ูุญููุฉ ุจู RLS
- ุงููุณุชุฎุฏููู ูุฑูู ุจูุงูุงุชูู ููุท
- Admin ูู ุตูุงุญูุงุช ุฅุถุงููุฉ

---

## ๐ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

### ุฑุณุงุฆู ุงูุฎุทุฃ ุงูุดุงุฆุนุฉ:

| ุญุงูุฉ ุงูุฎุทุฃ | ุงูุฑุณุงูุฉ |
|-----------|---------|
| Invalid credentials | ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ |
| User not found | ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ |
| Email not confirmed | ูุฑุฌู ุชุฃููุฏ ุจุฑูุฏู ุงูุฅููุชุฑููู |
| Too many attempts | ุชู ุฅุฌุฑุงุก ูุญุงููุงุช ูุซูุฑุฉ. ูุฑุฌู ุงูุงูุชุธุงุฑ |
| Network error | ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู |

### ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูู ุงูููุฏ:
```typescript
try {
  await loginMutation.mutateAsync({ email, password });
} catch (error: any) {
  if (error && typeof error === 'object' && 'message' in error) {
    setError(error.message);
  }
}
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุญุงูุงุช ุงูุงุฎุชุจุงุฑ:

1. โ ุชุณุฌูู ุฏุฎูู ูุงุฌุญ
2. โ ุชุณุฌูู ุฏุฎูู ุจุจูุงูุงุช ุฎุงุทุฆุฉ
3. โ ุชุณุฌูู ุฏุฎูู ุจุฏูู user record (ูุณุชุฎุฏู metadata)
4. โ ุชุณุฌูู ุฏุฎูู ูุน role ูุฎุชูู (admin/investor)
5. โ ูุนุงูุฌุฉ ุฃุฎุทุงุก Supabase
6. โ ุงุณุชุนุงุฏุฉ ุงูุฌูุณุฉ ุจุนุฏ ุฅุนุงุฏุฉ ุงูุชุญููู
7. โ ุชุณุฌูู ุงูุฎุฑูุฌ

---

## ๐ ุงููุฌุฑุฉ ูู ุงููุธุงู ุงููุฏูู

### ุงูุชุบููุฑุงุช ุงููุทููุจุฉ:

1. **ุงุณุชุจุฏุงู `useLogin` ุจู `useSupabaseLogin`**
   ```typescript
   // ูุจู
   import { useLogin } from '../hooks/useLogin';
   
   // ุจุนุฏ
   import { useSupabaseLogin } from '../hooks/useSupabaseLogin';
   ```

2. **ุชุญุฏูุซ ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู**
   - ุงุณุชุฎุฏุงู `useSupabaseLogin` ุจุฏูุงู ูู `useLogin`
   - ุฅุฒุงูุฉ ูุนุงูุฌุฉ ุงูุชูุฌูู ุงููุฏูู (ูุชู ุชููุงุฆูุงู)
   - ุชุจุณูุท ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

3. **ุชุญุฏูุซ AuthContext**
   - ูุนูู ุชููุงุฆูุงู ูุน Supabase
   - ูุง ุญุงุฌุฉ ูุชุบููุฑุงุช ุฅุถุงููุฉ

---

## ๐ ููุงุฑูุฉ ูุน ุงููุธุงู ุงููุฏูู

| ุงูููุฒุฉ | ุงููุธุงู ุงููุฏูู | ุงููุธุงู ุงูุฌุฏูุฏ |
|--------|--------------|---------------|
| ุงูุงุนุชูุงุฏ ุนูู Backend | โ ูุทููุจ | โ ุงุฎุชูุงุฑู |
| ุงูุชุนููุฏ | ุนุงูู | ููุฎูุถ |
| ุนุฏุฏ ุงููููุงุช | ูุชุนุฏุฏ | ูุจุณุท |
| ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช | ูุฏูู | ุชููุงุฆู |
| ุงูุชุญุฏูุซุงุช ุงูููุฑูุฉ | โ | โ |
| ุงูููุซูููุฉ | ูุชูุณุทุฉ | ุนุงููุฉ |

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. โ ุงุฎุชุจุงุฑ ุชุณุฌูู ุงูุฏุฎูู
2. โณ ุงุฎุชุจุงุฑ ุชุณุฌูู ุงูุฎุฑูุฌ
3. โณ ุงุฎุชุจุงุฑ ุงุณุชุนุงุฏุฉ ุงูุฌูุณุฉ
4. โณ ุงุฎุชุจุงุฑ ุงูุชูุฌูู ุญุณุจ ุงูุฏูุฑ
5. โณ ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

---

## ๐ ุงููุฑุงุฌุน

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Supabase JavaScript Client](https://supabase.com/docs/reference/javascript/auth-signinwithpassword)
- [React Query Documentation](https://tanstack.com/query/latest)

---

## ๐ก ููุงุญุธุงุช ูููุฉ

### 1. Supabase Client Configuration
ุชุฃูุฏ ูู ุฃู Supabase client ููุนุฏ ุจุดูู ุตุญูุญ:
```typescript
// frontend/src/utils/supabase-client.ts
client = createClient(SUPABASE.url, SUPABASE.anonKey, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
  },
});
```

### 2. Environment Variables
ุชุฃูุฏ ูู ูุฌูุฏ ุงููุชุบูุฑุงุช ุงูุชุงููุฉ:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`

### 3. RLS Policies
ุชุฃูุฏ ูู ุฃู RLS policies ููุนุฏุฉ ุจุดูู ุตุญูุญ ุนูู ุฌุฏูู `users`:
```sql
-- ุงููุณุชุฎุฏููู ูุฑูู ุจูุงูุงุชูู ููุท
CREATE POLICY "Users can view their own data"
  ON public.users FOR SELECT
  USING (auth.uid() = id);
```

---

## โ ุงูุฎูุงุตุฉ

ุชู ุฅูุดุงุก ูุธุงู ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ ูุจุณุท ููุชูุงูู ุจุงููุงูู ูุน Supabase:
- โ ุงุณุชุฎุฏุงู Supabase Auth ูุจุงุดุฑุฉ
- โ Hook ูุจุณุท ูุณูู ุงูุงุณุชุฎุฏุงู
- โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ
- โ ุชูุงูู ุชููุงุฆู ูุน AuthContext
- โ ุฅุฏุงุฑุฉ ุฌูุณุงุช ุชููุงุฆูุฉ
- โ ุชูุฌูู ุชููุงุฆู ุญุณุจ ุงูุฏูุฑ

ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู! ๐

