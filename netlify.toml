[build]
  command = "cd frontend && rm -rf node_modules package-lock.json .next && echo 'Step 1: Moving directories...' && if [ -d src/pages ]; then mv src/pages pages && echo '✓ Moved src/pages to pages'; else echo '✗ src/pages not found'; fi && if [ -d src/app ]; then mv src/app src/app-old && echo '✓ Moved src/app to src/app-old'; else echo '✗ src/app not found (OK)'; fi && echo 'Step 2: Fixing imports in pages/...' && if [ -d pages ]; then find pages -type f \\( -name '*.tsx' -o -name '*.ts' \\) -exec sed -i \"s|from '\\.\\./components|from '@/components|g; s|from '\\.\\./hooks|from '@/hooks|g; s|from '\\.\\./utils|from '@/utils|g; s|from '\\.\\./styles|from '@/styles|g; s|from '\\.\\./context|from '@/context|g; s|from '\\.\\./types|from '@/types|g; s|from '\\.\\./locales|from '@/locales|g\" {} \\; && echo '✓ Fixed imports'; else echo '✗ pages directory not found'; fi && echo 'Step 3: Installing dependencies...' && npm install && echo 'Step 4: Starting build...' && npm run build"
  functions = "netlify/functions"
  publish = "frontend/.next"

[build.environment]
  NODE_VERSION = "22"

[[plugins]]
  package = "@netlify/plugin-nextjs"

# API redirects - must come before other redirects
# This redirects all /api/v1/* requests to the serverless function
[[redirects]]
  from = "/api/v1/*"
  to = "/.netlify/functions/server/:splat"
  status = 200
  force = true

# Exclude static files from SPA redirect
[[redirects]]
  from = "/robots.txt"
  to = "/robots.txt"
  status = 200

[[redirects]]
  from = "/manifest.json"
  to = "/manifest.json"
  status = 200

[[redirects]]
  from = "/sw.js"
  to = "/sw.js"
  status = 200

[[redirects]]
  from = "/offline.html"
  to = "/offline.html"
  status = 200

[[headers]]
  for = "/sw.js"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"
    Service-Worker-Allowed = "/"

[[headers]]
  for = "/manifest.json"
  [headers.values]
    Content-Type = "application/manifest+json"
    Cache-Control = "public, max-age=3600"

# Next.js handles routing, so we don't need catch-all redirect
# [[redirects]]
#   from = "/*"
#   to = "/index.html"
#   status = 200

[functions]
  node_bundler = "esbuild"
  included_files = ["backend/src/**", "backend/dist/**"]

