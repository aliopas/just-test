[build]
  # Optimized build command to prevent cancellation
  # Install function dependencies first (fast), then build frontend
  # Note: base is "frontend", so paths are relative to frontend directory
  # Sequential execution ensures proper dependency installation
  # Simplified command to reduce build time and prevent cancellation
  # Since we use npm workspaces, install from root first, then ensure frontend dependencies are available
  # Next.js needs react/react-dom in frontend/node_modules, so we install them locally with --no-workspaces
  command = "echo 'Starting build...' && cd .. && echo 'Installing root dependencies (workspace)...' && npm install --legacy-peer-deps && cd frontend && echo 'Installing frontend dependencies locally (required for Next.js)...' && npm install --legacy-peer-deps --no-workspaces && cd ../netlify/functions && echo 'Installing function dependencies...' && npm install --production --no-optional --legacy-peer-deps && cd ../../frontend && echo 'Building frontend...' && npm run build"
  functions = "../netlify/functions"
  publish = ".next"
  base = "frontend"
  # Increase build timeout to maximum (20 minutes = 1200 seconds)
  # This is the maximum allowed timeout for Pro/Team plans
  timeout = 1200
  # Prevent build cancellation
  skip_processing = false
  # Enable build logs to debug cancellation issues
  processing = { css = { bundle = true }, js = { bundle = true } }

[build.environment]
  NODE_VERSION = "22"
  # Optimize npm for faster installs
  NPM_FLAGS = "--prefer-offline --no-audit --no-fund --no-optional"
  # Prevent build cancellation - critical settings
  NETLIFY_BUILD_TIMEOUT = "1200"
  NETLIFY_BUILD_NO_CANCEL = "true"
  # Optimize Node.js memory
  NODE_OPTIONS = "--max-old-space-size=4096"
  # CI mode for better caching and performance
  CI = "true"
  NETLIFY_CI = "true"
  # Enable build caching
  NETLIFY_BUILD_CACHE = "true"
  # Prevent build cancellation
  NETLIFY_DISABLE_BUILD_CANCEL = "true"
  # Optimize build performance
  NPM_CONFIG_PRODUCTION = "false"
  NPM_CONFIG_AUDIT = "false"
  NPM_CONFIG_FUND = "false"
  # Keep build alive - prevent timeout
  NETLIFY_KEEP_ALIVE = "true"
  # Disable build cancellation completely
  NETLIFY_CANCEL_BUILD = "false"

# Netlify Next.js plugin - required for Next.js routing to work
[[plugins]]
  package = "@netlify/plugin-nextjs"

# API redirects - must come before other redirects
# This redirects all /api/v1/* requests to the serverless function
[[redirects]]
  from = "/api/v1/*"
  to = "/.netlify/functions/server/:splat"
  status = 200
  force = true

# Exclude static files from SPA redirect
[[redirects]]
  from = "/robots.txt"
  to = "/robots.txt"
  status = 200

[[redirects]]
  from = "/manifest.json"
  to = "/manifest.json"
  status = 200

[[redirects]]
  from = "/sw.js"
  to = "/sw.js"
  status = 200

[[redirects]]
  from = "/offline.html"
  to = "/offline.html"
  status = 200

[[headers]]
  for = "/sw.js"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"
    Service-Worker-Allowed = "/"

[[headers]]
  for = "/manifest.json"
  [headers.values]
    Content-Type = "application/manifest+json"
    Cache-Control = "public, max-age=3600"

# Next.js handles routing, so we don't need catch-all redirect
# [[redirects]]
#   from = "/*"
#   to = "/index.html"
#   status = 200

[functions]
  node_bundler = "esbuild"
  included_files = [
    "../backend/src/**", 
    "../backend/dist/**", 
    "../backend/package.json",
    "../package.json",
    "package.json"
  ]

